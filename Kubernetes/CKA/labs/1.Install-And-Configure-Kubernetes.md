# Install and Configure Kubernetes

[Configuration Guide Source](https://medium.com/@mojabi.rafi/create-a-kubernetes-cluster-using-virtualbox-and-without-vagrant-90a14d791617)

### Setting up Kubernetes cluster in action
In the nutshell, we are going to implement the following architecture for setting up our Kubernetes cluster.

![](img/1.Environemnt-diagram.png)

### There are some key-points apparent in the figure 1.
- We start off by 1 master node
- We have 3 worker nodes
- Each VM has 2 network interfaces.
- One network interface is attached to default NAT network in virtualbox. the purpose of this network is to provide the node internet access.
- Another network interface is attached to a Host-Only network in virtualbox. All inside cluster communications would be through this network.

<br>

## Prepare VirtualBox machines for deploying Kubernetes cluster
According to diagram below, We need a private network that nodes can communicate with each other though. To create one go to **File** -> **Host Network Manager**. Create new network there with **no DHCP Enable** option. Use 192.168.60.1/24 for IP range.

![](img/2.VirtualBox-Network-Manager.png)


<br>


## VM’s OS and configuration
Use following setup as of our VMs

- **Master**
    * Name: `master#` (number of master in the cluster)
    * OS: `ubuntu-server-18.04`
    * CPU: `2 core`
    * Memory: `2GB`
- **Workers**
  * OS: `ubuntu-server-18.04`
  * CPU: `1 core`
  * Memory: `1GB`
  
Please note each of the VMs should benefit from 2 networks. One default NAT network which provides internet access to our node, Another attached to Host Only Network created in previous step.


<br>

After setting up the VM virtual hardware, it is time to install our operating system. Assign desired IP address in the range provided by Host Only adapter manually:

| **Node**  | **IP Address** |
|-----------|----------------|
| master01  | 192.168.60.11  |
| worker01  | 192.168.60.21  |
| worker02  | 192.168.60.22  |
| worker03  | 192.168.60.23  |


> **Note:** 
> 
> - You should not set gateway 192.168.60.1 for any Node, Or you will have to change the default route (The route we need for Internet connection) to the NAT interface after OS install.
> - Among All packages the installer ask you about, only select OpenSSH package to be installed.
> - Having OS installed and VM up and running, you should be able to ping the IP address of the VM.



<br><br><br>


## Setup Kubernetes cluster using kubeadm tool
There are several ways to setup Kubernetes cluster. We are going to leverage `kubeadm` tool. `kubeadm` enable us to create Kubernetes cluster that will pass Kubernetes Conformance tests. `kubeadm` also support providing tokens, cluster upgrade etc.


Install required components


Each of the nodes need the following components available:
- `kubelet`: The kubelet is the primary “node agent” that runs on each node. It can register the node with the apiserver using one of: the hostname; a flag to override the hostname; or specific logic for a cloud provider.
- `kubectl`: The Kubernetes command-line tool, kubectl, allows you to run commands against Kubernetes clusters. You can use kubectl to deploy applications, inspect and manage cluster resources, and view logs.
- `kubeadm`: Using kubeadm, you can create a minimum viable Kubernetes cluster that conforms to best practices.


<br>

### Step 1- Installing required components

#### Install `kubeadm`, `kubelet` and `kubectl`
On each nodes, add the kubernetes repository

```sh
sudo apt update && sudo apt install -y curl
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add
sudo apt-add-repository "deb http://apt.kubernetes.io/ kubernetes-xenial main"
```

Having required repository added, install required components. At the time, the latest version of kubernets is 1.25.0. Yet as for more stability, we are going to use kubernetes version 1.22.10 for our cluster.
First, lets list what versions are available:

```sh
# Verify version is available
apt list -a kubeadm

# Install
sudo apt install -y kubeadm=1.22.10-00 kubelet=1.22.10-00 kubectl=1.22.10-00
```


It is recommended to hold the version on installed packages. We really don’t want to mess up with kubernetes auto updates:

```sh
sudo apt-mark hold kubeadm kubelet kubectl
```


Check the version of installed components and it should be as version we just installed
```sh
kubead version
```



#### Install `docker`
Next step is to install Docker on the nodes. The official document on installing docker on Ubunut can be found here. Yer for the sake of simplicity, we install it using a simple command as follow:

```sh
sudo apt install -y docker.io
```

You can verify installation using
```sh
docker version
```

Docker will not start on system startup. meanwhile it is a requisite for kubernetes cluster to be functional. Do Not forget to enable its service to make sure docker will get up and work on each node restart

```sh
sudo systemctl enable docker
```


<br><br><br>


## Changing Docker Cgroup Driver
It is crucial to change docker cgroup Driver after install or you get error regarding “Docker group driver detected cgroupfs instead systemd” on cluster initialization. It is easy, and should be done on all nodes (master and workers).

```sh
sudo cat <<EOF | sudo tee /etc/docker/daemon.json
{ "exec-opts": ["native.cgroupdriver=systemd"],
"log-driver": "json-file",
"log-opts":
{ "max-size": "100m" },
"storage-driver": "overlay2"
}
EOF
```

Restart Docker and make sure it is up and running
```sh
sudo systemctl restart docker
```

You can check if the Cgroup driver is changes to systemd
```sh
sudo docker info | grep -i cgroup
```

